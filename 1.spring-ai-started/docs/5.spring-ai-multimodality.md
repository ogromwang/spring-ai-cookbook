# 多模态 API

多模态 API 允许在对话中同时使用文本和图像等媒体内容。这对于图像分析、视觉问答、文档理解等场景非常有用。Spring AI 的 ChatClient 支持在提示词中添加图像、音频等多媒体内容。

## 基本用法

[MultimodalApiTest](https://github.com/dong4j/spring-ai-cookbook/blob/main/1.spring-ai-started/src/test/java/dev/dong4j/ai/spring/multimodal/MultimodalApiTest.java)

::: code-group

```java [java:文本 + 图像输入]
@Test
void testTextAndImageInput() {
    ChatClient client = chatClientBuilder.build();

    // 从类路径加载图像
    Resource imageResource = new ClassPathResource("images/test1.jpg");

    // 同时使用文本和图像
    String reply = client.prompt()
        .user(u -> u
            .text("请分析这张图片，描述其中的主要内容")
            .media(MimeTypeUtils.IMAGE_JPEG, imageResource))
        .call()
        .content();

    assertThat(reply).isNotNull().isNotEmpty();
    log.info("图像分析结果: {}", reply);
}
```

```java [java:多张图像输入]
@Test
void testMultipleImagesInput() {
    ChatClient client = chatClientBuilder.build();

    Resource image1 = new ClassPathResource("images/test1.jpg");
    Resource image2 = new ClassPathResource("images/test2.png");

    // 同时分析多张图片
    String reply = client.prompt()
        .user(u -> u
            .text("请对比这两张图表，找出它们的差异")
            .media(MimeTypeUtils.IMAGE_JPEG, image1)
            .media(MimeTypeUtils.IMAGE_PNG, image2))
        .call()
        .content();

    assertThat(reply).isNotNull().isNotEmpty();
    log.info("图像对比结果: {}", reply);
}
```

```java [java:从 URL 加载图像]
@Test
void testImageFromUrl() {
    ChatClient client = chatClientBuilder.build();

    // 从 URL 加载图像
    try {
        Resource imageUrl = new UrlResource("https://cdn.dong4j.site/source/image/avatar.webp");

        String reply = client.prompt()
            .user(u -> u
                .text("这张图片展示了什么？")
                .media(MimeTypeUtils.IMAGE_PNG, imageUrl))
            .call()
            .content();

        assertThat(reply).isNotNull().isNotEmpty();
        log.info("URL 图像分析结果: {}", reply);
    } catch (Exception e) {
        log.info("跳过测试：无法访问图像 URL - {}", e.getMessage());
    }
}
```

```java [java:图像 + 结构化输出]
@Test
void testImageWithStructuredOutput() {
    ChatClient client = chatClientBuilder.build();
    Resource image = new ClassPathResource("images/test1.jpg");

    // 结合结构化输出分析图像
    ImageAnalysis analysis = client.prompt()
        .user(u -> u
            .text("""
                      请分析这张产品图片，提取以下信息(使用中文)：
                      - 主要产品名称
                      - 图片中的对象列表
                      - 产品描述
                      """)
            .media(MimeTypeUtils.IMAGE_JPEG, image))
        .call()
        .entity(ImageAnalysis.class);

    assertThat(analysis).isNotNull();
    assertThat(analysis.mainSubject()).isNotNull().isNotEmpty();
    assertThat(analysis.objects()).isNotNull();
    assertThat(analysis.description()).isNotNull().isNotEmpty();

    log.info("产品: {}", analysis.mainSubject());
    log.info("对象: {}", analysis.objects());
    log.info("描述: {}", analysis.description());
}
```

:::

> **⚠️ 注意事项**：
>
> 以上示例代码使用了专门的配置文件 `application-multimodal.yml`，通过 `@ActiveProfiles("multimodal")` 注解加载。该配置文件指定了支持多模态的模型（如 `qwen-vl-plus`），与默认的 `application.yml` 配置不同。
>
> - **配置文件位置**：`src/test/resources/application-multimodal.yml`
> - **切换模型**：在配置文件中修改 `spring.ai.openai.chat.options.model` 值
> - **支持的模型**：`qwen-vl-max`、`qwen-vl-plus` 等支持多模态的模型
> - **模型支持**：并非所有 AI 模型都支持多模态输入，需要确认使用的模型是否支持（如 GPT-4 Vision、Claude 3 等）
> - **图像大小**：注意图像文件大小限制，某些模型对图像分辨率有要求
> - **资源加载**：确保图像资源路径正确，可以使用 `ClassPathResource`、`FileSystemResource` 或 `UrlResource`
> - **成本考虑**：多模态请求通常比纯文本请求消耗更多 token，成本更高

## 支持的媒体类型

Spring AI 支持多种媒体类型，常见的有：

- **图像**：`MimeTypeUtils.IMAGE_PNG`、`MimeTypeUtils.IMAGE_JPEG`、`MimeTypeUtils.IMAGE_GIF` 等
- **音频**：`MimeTypeUtils.AUDIO_MPEG`、`MimeTypeUtils.AUDIO_WAV` 等
- **视频**：部分模型支持视频输入（取决于具体的 AI 模型）

## 使用场景

1. **图像分析**：分析图片内容、识别物体、提取文字（OCR）
2. **视觉问答**：基于图像回答问题
3. **文档理解**：分析包含图表的文档
4. **产品识别**：识别产品、提取产品信息
5. **代码截图分析**：分析代码截图并生成解释

## 参考文档

- [Spring AI ChatClient 官方文档](https://docs.spring.io/spring-ai/reference/api/chatclient.html)
- [Spring AI 多模态支持](https://docs.spring.io/spring-ai/reference/api/chatmodel.html#_multimodal_support)

## 继续深入

- [[5.spring-ai-multimodality/index|多模态 API]]

---
