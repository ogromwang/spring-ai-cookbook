# 结构化输出

在实际应用中，我们通常需要将 AI 模型的文本输出转换为结构化的 Java 对象，而不是直接处理字符串。Spring AI 提供了强大的结构化输出功能，可以将 AI 的响应自动映射到 POJO（Plain Old Java Object）。

## 基本用法

[StructuredOutputTest](https://github.com/dong4j/spring-ai-cookbook/blob/main/1.spring-ai-started/src/test/java/dev/dong4j/ai/spring/structured/StructuredOutputTest.java)

::: code-group

```java [java:使用 entity() 方法]
// 定义数据类
record ActorFilms(String actor, List<String> movies) {}

ChatClient client = ChatClient.create(chatModel);

// 直接返回 Java 对象
ActorFilms result = client.prompt()
    .user("生成一个随机演员的电影作品列表")
    .call()
    .entity(ActorFilms.class);

System.out.println("演员: " + result.actor());
System.out.println("电影: " + result.movies());
```

```java [java:返回 List 类型]
record ActorFilms(String actor, List<String> movies) {}

ChatClient client = ChatClient.create(chatModel);

// 返回 List 需要使用 ParameterizedTypeReference
List<ActorFilms> results = client.prompt()
    .user("生成 5 个演员的电影作品列表，包括 Tom Hanks 和 Bill Murray")
    .call()
    .entity(new ParameterizedTypeReference<List<ActorFilms>>() {});

results.forEach(actor -> {
    System.out.println(actor.actor() + ": " + actor.movies());
});
```

```java [java:使用 BeanOutputConverter]
import org.springframework.ai.converter.BeanOutputConverter;
import org.springframework.core.ParameterizedTypeReference;

record Product(String name, String description, Double price, List<String> features) {}

ChatClient client = ChatClient.create(chatModel);
BeanOutputConverter<Product> converter = new BeanOutputConverter<>(Product.class);

// 在提示词中包含格式说明
String format = converter.getFormat();
String prompt = """
    请为 Spring AI 创建一个产品介绍。
    格式要求：
    %s
    """.formatted(format);

Product product = client.prompt()
    .user(prompt)
    .call()
    .entity(Product.class);
```

```java [java:流式响应转结构化]
import org.springframework.ai.converter.BeanOutputConverter;
import reactor.core.publisher.Flux;
import java.util.stream.Collectors;

record ActorFilms(String actor, List<String> movies) {}

ChatClient client = ChatClient.create(chatModel);
BeanOutputConverter<List<ActorFilms>> converter = 
    new BeanOutputConverter<>(new ParameterizedTypeReference<List<ActorFilms>>() {});

// 流式获取响应
Flux<String> flux = client.prompt()
    .user(u -> u
        .text("生成 3 个演员的电影作品列表。格式要求：\n{format}")
        .param("format", converter.getFormat()))
    .stream()
    .content();

// 聚合流式响应并转换
String content = flux.collectList()
    .block()
    .stream()
    .collect(Collectors.joining());

List<ActorFilms> results = converter.convert(content);
```

:::

## 工作原理

1. **自动格式生成**：`BeanOutputConverter` 会根据 Java 类的字段自动生成 JSON Schema 格式说明
2. **提示词增强**：将格式说明添加到提示词中，引导 AI 生成符合格式的 JSON
3. **自动解析**：AI 返回 JSON 后，Spring AI 自动将其解析为 Java 对象

## 参考文档

- [Spring AI Structured Output Converter 官方文档](https://docs.spring.io/spring-ai/reference/api/structured-output-converter.html)
- [Spring AI ChatClient 文档](https://docs.spring.io/spring-ai/reference/api/chatclient.html)

## 继续深入

- [[4.spring-ai-structured/index|结构化输出]]

---
